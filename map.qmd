---
page-layout: full
comments: false
css: css/map.css
---

```{r}
#| column: screen
#| echo: false
#| message: false
#| warning: false
#| out-height: 100vh
#| out-width: 100%
library(tidyverse)
library(leaflet)
library(htmltools)
library(leaflet.extras)
library(sf)

# Grillas
churo <- st_read('data/datos/churo_variables.gpkg',quiet = TRUE) |> st_transform(crs = 4326)
ohuay <- st_read('data/datos/ohuay_variables.gpkg',quiet = TRUE) |> st_transform(crs = 4326)
huaccaycancha <- st_read('data/datos/huaccaycancha_variables.gpkg',quiet = TRUE) |> st_transform(crs = 4326)
huayllapata <- st_read('data/datos/huayllapata_variables.gpkg',quiet = TRUE) |> st_transform(crs = 4326)

# Drones 
drones_rgb <- read_csv('data/drones-gee.csv')

# Casos
casos <- st_read('data/grid/cavada.gpkg',quiet = TRUE) |> 
  select(con_caracoles) |> 
  filter(con_caracoles == 1)

# Mapa web
map_layers <- function() {
  #number of groups
  k <- c(
    "churo",
    "ohuay",
    "huaccaycancha",
    "huayllapata"
    )
  
  #base map
  map <- leaflet() |> 
    addTiles(group = "Open.Street.Map") |>
    addProviderTiles(provider = providers$CartoDB,group = "CartoDB") |>
    addProviderTiles(provider = providers$CartoDB.DarkMatter,group = "CartoDB.DarkMatter") |>
    addProviderTiles(provider = providers$Esri.WorldImagery,group = "Esri.WorldImagery") |>
    addHeatmap(data = casos,minOpacity = 0.6,radius = 12,intensity = casos$con_caracoles) |> 
    setView(lng = -71.65427,lat = -13.49480,zoom = 14)
  #loop through all groups and add a layer one at a time
  for (i in 1:length(k)) {
    if("churo" == k[[i]]){
      map <- map |> 
        addTiles(urlTemplate = drones_rgb$url[1],group = "churo") |> 
        addPolygons(
          data = churo,
          group = "churo-grid",
          weight = 1,
          fillColor = 'transparent',
          popup = ~paste0(
            "<center><h3> 🏕️ Churo </h3></center>", "<hr>",
            "- 🟩 Cases: ", round(churo$casos, 4), "<br>",
            "- 🟩 Green band: ", round(churo$green, 4), "<br>",
            "- 🔴 Red band: ", round(churo$red, 4), "<br>",
            "- 🟥 Red edge band: ", round(churo$redge), "<br>",
            "- 🌿 Near-infrared band: ", round(churo$nir, 4), "<br>",
            "- 🌡️ Temperature: ", round(churo$tir, 4), "<br>",
            "- ⛰️ Elevation: ", round(churo$dem, 4), "<br>",
            "- 🧭 Aspect: ", round(churo$aspect, 4), "<br>",
            "- 🌱 NDVI: ", round(churo$ndvi, 4), "<br>",
            "- 🌾 SAVI: ", round(churo$savi, 4), "<br>",
            "- ⛰️ Slope: ", round(churo$slope, 4), "<br>",
            "- 🏞️ Valley depth: ", round(churo$vall_depth, 4), "<br>",
            "- 💧 Topographic wetness: ", round(churo$wetness, 4)
          )
        )
    }
    if("ohuay" == k[[i]]){
      map <- map |> 
        addTiles(urlTemplate = drones_rgb$url[2],group = "ohuay") |> 
         addPolygons(
           data = ohuay,
           group = "ohuay-grid",
           weight = 1,
           fillColor = 'transparent',
           popup = ~paste0(
            "<center><h3> 🏕️Ohuay </h3></center>", "<hr>",
            "- 🟩 Cases: ", round(ohuay$casos, 4), "<br>",
            "- 🟩 Green band: ", round(ohuay$green, 4), "<br>",
            "- 🔴 Red band: ", round(ohuay$red, 4), "<br>",
            "- 🟥 Red edge band: ", round(ohuay$redge), "<br>",
            "- 🌿 Near-infrared band: ", round(ohuay$nir, 4), "<br>",
            "- 🌡️ Temperature: ", round(ohuay$tir, 4), "<br>",
            "- ⛰️ Elevation: ", round(ohuay$dem, 4), "<br>",
            "- 🧭 Aspect: ", round(ohuay$aspect, 4), "<br>",
            "- 🌱 NDVI: ", round(ohuay$ndvi, 4), "<br>",
            "- 🌾 SAVI: ", round(ohuay$savi, 4), "<br>",
            "- ⛰️ Slope: ", round(ohuay$slope, 4), "<br>",
            "- 🏞️ Valley depth: ", round(ohuay$vall_depth, 4), "<br>",
            "- 💧 Topographic wetness: ", round(ohuay$wetness, 4)
          )
        )
      
    }
    
    if("huaccaycancha" == k[[i]]){
      map <- map |> 
         addTiles(urlTemplate = drones_rgb$url[4],group = "huaccaycancha") |> 
         addPolygons(
           data = huaccaycancha,
           group = "huaccaycancha-grid",
           weight = 1,
           fillColor = 'transparent',
           popup = ~paste0(
            "<center><h3> 🏕️Huaccaycancha </h3></center>", "<hr>",
            "- 🟩 Cases: ", round(huaccaycancha$casos, 4), "<br>",
            "- 🟩 Green band: ", round(huaccaycancha$green, 4), "<br>",
            "- 🔴 Red band: ", round(huaccaycancha$red, 4), "<br>",
            "- 🟥 Red edge band: ", round(huaccaycancha$redge), "<br>",
            "- 🌿 Near-infrared band: ", round(huaccaycancha$nir, 4), "<br>",
            "- 🌡️ Temperature: ", round(huaccaycancha$tir, 4), "<br>",
            "- ⛰️ Elevation: ", round(huaccaycancha$dem, 4), "<br>",
            "- 🧭 Aspect: ", round(huaccaycancha$aspect, 4), "<br>",
            "- 🌱 NDVI: ", round(huaccaycancha$ndvi, 4), "<br>",
            "- 🌾 SAVI: ", round(huaccaycancha$savi, 4), "<br>",
            "- ⛰️ Slope: ", round(huaccaycancha$slope, 4), "<br>",
            "- 🏞️ Valley depth: ", round(huaccaycancha$vall_depth, 4), "<br>",
            "- 💧 Topographic wetness: ", round(huaccaycancha$wetness, 4)
          )
        )
    }
    
    if("huayllapata" == k[[i]]){
      map <- map |> 
         addTiles(urlTemplate = drones_rgb$url[3],group = "huayllapata") |> 
         addPolygons(
           data = huayllapata,
           group = "huayllapata-grid",
           weight = 1,
           fillColor = 'transparent',
           popup = ~paste0(
            "<center><h3> 🏕️Huayllapata </h3></center>", "<hr>",
            "- 🟩 Cases: ", round(huayllapata$casos, 4), "<br>",
            "- 🟩 Green band: ", round(huayllapata$green, 4), "<br>",
            "- 🔴 Red band: ", round(huayllapata$red, 4), "<br>",
            "- 🟥 Red edge band: ", round(huayllapata$redge), "<br>",
            "- 🌿 Near-infrared band: ", round(huayllapata$nir, 4), "<br>",
            "- 🌡️ Temperature: ", round(huayllapata$tir, 4), "<br>",
            "- ⛰️ Elevation: ", round(huayllapata$dem, 4), "<br>",
            "- 🧭 Aspect: ", round(huayllapata$aspect, 4), "<br>",
            "- 🌱 NDVI: ", round(huayllapata$ndvi, 4), "<br>",
            "- 🌾 SAVI: ", round(huayllapata$savi, 4), "<br>",
            "- ⛰️ Slope: ", round(huayllapata$slope, 4), "<br>",
            "- 🏞️ Valley depth: ", round(huayllapata$vall_depth, 4), "<br>",
            "- 💧 Topographic wetness: ", round(huayllapata$wetness, 4)
          )
        )
    }
    
  }
  
  #create layer control
  map <-  map %>% 
    addLayersControl(
      baseGroups = c("Open.Street.Map","CartoDB","CartoDB.DarkMatter","Esri.WorldImagery"),
      overlayGroups = c(k[c(1:length(k))],paste0(k[c(1:length(k))],'-grid')),
      options = layersControlOptions(collapsed = FALSE)
    ) 
  map <- map |> hideGroup(as.character(k[c(0:length(k))]))  #hide all groups except the 1st one
  
  map
}

#plot the map
map_layers()
```